COMMON_FLAGS = -O3 -DNDEBUG -Wpedantic -Wall -Wextra -Wpedantic -I./include -Lwlib -mwindows \
               -I./Amscript2/include -L./Amscript2/lib -mconsole
CFLAGS = -std=gnu99 $(COMMON_FLAGS)
CPPFLAGS = -std=gnu++17 $(COMMON_FLAGS)
ALL_MAIN_SRCS =\
	$(patsubst src/main/%.c, wbin/%, $(wildcard src/main/*.c))\
	$(patsubst src/main/%.cpp, wbin/%, $(wildcard src/main/*.cpp))
C_SRCS = $(wildcard src/*.c)
CPP_SRCS = $(wildcard src/*.cpp)
ALL_OBJS =\
	$(patsubst src/%.c, wbuild/%.o, $(C_SRCS))\
	$(patsubst src/%.cpp, wbuild/%.o, $(CPP_SRCS))
OPTS = $(shell cat make_opts_win)


sneka.exe: wbin/snekaintest
	ln -f "$<".exe "$@"
	strip "$@"


# compiles all objects, and creates executable files from ./src/main
make_exec: $(ALL_MAIN_SRCS)

# objects should not be removed automatically
.PRECIOUS: wbuild/%.o

# external Amscript2 dependency
Amscript2/lib/libamscript2.a:
	git submodule update --init Amscript2
	$(MAKE) --directory="Amscript2" $(patsubst Amscript2/%,%,$@)

# links all C source files from ./src/main
wbin/%: $(ALL_OBJS) src/main/%.c
	mkdir -p wbin/
	#
	# ----- C executable ----- #
	gcc $(CFLAGS) -o"$@" $^ $(OPTS)

# links all C++ source files from ./src/main
wbin/%: $(ALL_OBJS) src/main/%.cpp
	mkdir -p wbin/
	#
	# ----- C++ executable ----- #
	g++ $(CPPFLAGS) -o"$@" $^ $(OPTS)

# compiles a C source file from ./src
wbuild/%.o: src/%.c Amscript2/lib/libamscript2.a
	mkdir -p wbuild/
	#
	# ----- C object ----- #
	gcc $(CFLAGS) $< -c -o $@

# compiles a C++ source file from ./src
wbuild/%.o: src/%.cpp Amscript2/lib/libamscript2.a
	mkdir -p wbuild/
	#
	# ----- C++ object ----- #
	g++ $(CPPFLAGS) $< -c -o $@

setup:
	#
	# ----- Workspace creation ----- #
	mkdir -p src src/main wbuild wbin include
	printf '' >>make_opts_win

clean:
	rm -rf wbuild
	mkdir wbuild

purge:
	rm -rf wbin wbuild Amscript2/lib
	mkdir wbin wbuild Amscript2/lib
